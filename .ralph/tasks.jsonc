{
  "tasks": {
    // Gate responses for select options (approve/reject confirmations)
    "gate": {
      "approve": { "run": "true" },
      "reject": { "run": "false" }
    },

    // Session lifecycle tasks
    "session": {
      "log-completed": {
        "run": "echo \"[after-session] Session ${RALPH_SESSION_ID} completed\""
      },
      "log-summary": {
        "run": "echo \"[after-session] Summary: ${RALPH_SESSION_DIR}/summary.md\""
      },
      "write-hooks-log": {
        "run": "test -n \"${RALPH_SESSION_DIR}\" && printf '%s [INFO] [after-session] Session %s completed\\n' \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\" \"${RALPH_SESSION_ID}\" >> \"${RALPH_SESSION_DIR}/hooks.log\" || true"
      },
      "write-event": {
        "run": "test -n \"${RALPH_SESSION_DIR}\" && printf '{\"timestamp\":\"%s\",\"type\":\"session\",\"status\":\"completed\",\"session_id\":\"%s\"}\\n' \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\" \"${RALPH_SESSION_ID}\" >> \"${RALPH_SESSION_DIR}/events.jsonl\" || true"
      }
    },

    // Reusable condition checks for hooks/tasks
    "conditions": {
      "workspace-empty": {
        // True when workspace has no tracked content (ignores .git/.ralph)
        "run": "test -z \"$(find \"${RALPH_WORKSPACE}\" -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.ralph' -print -quit 2>/dev/null || true)\""
      },
      "workflow-not-set": {
        // True when no workflow type has been selected
        "run": "test -z \"${RALPH_WORKFLOW_TYPE:-}\""
      },
      // Response file conditions (used in quality-gate)
      "response-exists": {
        "run": "test -f \"${RALPH_RESPONSE_FILE}\""
      },
      "response-not-empty": {
        "run": "test -s \"${RALPH_RESPONSE_FILE}\""
      }
    },

    // Validation checks (used by bootstrap hook)
    "validate": {
      "workspace-exists": {
        // Abort if workspace directory doesn't exist
        "run": "test -d \"${RALPH_WORKSPACE:-.}\" || { echo \"ERROR: Workspace not found: ${RALPH_WORKSPACE:-.}\" >&2; exit 1; }"
      },
      "engine-available": {
        // Check that at least one AI engine is available (skip in dry-run)
        "run": "test \"${RALPH_DRY_RUN:-0}\" = \"1\" || command -v codex >/dev/null 2>&1 || command -v claude >/dev/null 2>&1 || test -n \"${OPENAI_API_KEY:-}\" || test -n \"${ANTHROPIC_API_KEY:-}\" || { echo \"ERROR: No AI engine available. Install codex, claude, or set API keys.\" >&2; exit 1; }"
      },
      "timeout-valid": {
        // Check timeout is a valid non-negative integer
        "run": "test -z \"${RALPH_TIMEOUT:-}\" || test \"${RALPH_TIMEOUT}\" -ge 0 2>/dev/null || { echo \"ERROR: --timeout must be >= 0\" >&2; exit 1; }"
      },
      "plan-file-readable": {
        // Check plan file exists and is readable
        "run": "test -z \"${RALPH_PLAN_FILE:-}\" || test -r \"${RALPH_PLAN_FILE}\" || { echo \"ERROR: Plan file not readable: ${RALPH_PLAN_FILE}\" >&2; exit 1; }"
      }
    },

    // Bootstrap tasks (environment setup, prerequisites)
    "bootstrap": {
      "load-env": {
        // Load .env file from workspace if present
        "run": "test -f \"${RALPH_WORKSPACE:-.}/.env\" && { set -a; . \"${RALPH_WORKSPACE:-.}/.env\"; set +a; } || true"
      },
      "check-tools": {
        // Verify recommended tools are available
        "run": "command -v jq >/dev/null 2>&1 || echo \"[bootstrap] Warning: jq not found, some features may be limited\" >&2; true"
      },
      "print-config": {
        // Debug: print resolved configuration
        "run": "echo \"[bootstrap] workspace=${RALPH_WORKSPACE:-?}\"; echo \"[bootstrap] engine=${RALPH_ENGINE:-auto}\"; echo \"[bootstrap] dry_run=${RALPH_DRY_RUN:-0}\""
      }
    },

    // Utility commands
    "util": {
      "timestamp-iso": {
        // Print current UTC timestamp in ISO format
        "run": "date -u +%Y-%m-%dT%H:%M:%SZ"
      },
      "timestamp-compact": {
        // Print compact timestamp for filenames
        "run": "date -u +%Y%m%d_%H%M%S"
      }
    },

    // Tool availability detection
    "has": {
      "jq": { "run": "command -v jq >/dev/null 2>&1" },
      "rsync": { "run": "command -v rsync >/dev/null 2>&1" },
      "curl": { "run": "command -v curl >/dev/null 2>&1" },
      "git": { "run": "command -v git >/dev/null 2>&1" },
      "docker": { "run": "command -v docker >/dev/null 2>&1" }
    },

    // Docker operations
    "docker": {
      "image-exists": {
        // Check if ralph docker image exists
        "run": "docker image inspect ralph >/dev/null 2>&1"
      },
      "build": {
        // Build ralph docker image
        "run": "echo 'Building ralph docker image...' && docker build -t ralph -f \"${RALPH_SCRIPT_DIR:-$(pwd)}/Dockerfile\" \"${RALPH_SCRIPT_DIR:-$(pwd)}\" && echo 'Done.'"
      }
    },

    // Plan file operations
    "plan": {
      "exists": {
        // True if plan file exists
        "run": "test -f \"${RALPH_PLAN_FILE:-${RALPH_WORKSPACE}/.ralph/plans/plan.json}\""
      },
      "has-steps": {
        // True if plan has .steps array
        "run": "jq -e '.steps | type == \"array\"' \"${RALPH_PLAN_FILE:-${RALPH_WORKSPACE}/.ralph/plans/plan.json}\" >/dev/null 2>&1"
      },
      "has-pending": {
        // True if plan has pending steps
        "run": "jq -e '[.steps[] | select(.status == \"pending\")] | length > 0' \"${RALPH_PLAN_FILE:-${RALPH_WORKSPACE}/.ralph/plans/plan.json}\" >/dev/null 2>&1"
      },
      "step-count": {
        // Print number of steps
        "run": "jq -r '.steps | length' \"${RALPH_PLAN_FILE:-${RALPH_WORKSPACE}/.ralph/plans/plan.json}\" 2>/dev/null || echo 0"
      },
      "pending-count": {
        // Print number of pending steps
        "run": "jq -r '[.steps[] | select(.status == \"pending\")] | length' \"${RALPH_PLAN_FILE:-${RALPH_WORKSPACE}/.ralph/plans/plan.json}\" 2>/dev/null || echo 0"
      }
    },

    // Checkpoint operations
    "checkpoint": {
      "copy-rsync": {
        // Copy workspace using rsync (preferred)
        "when": "task:has.rsync",
        "run": "rsync -a --delete --exclude '.git/' --exclude '.ralph/sessions/' --exclude '.ralph/checkpoints/' \"${RALPH_WORKSPACE}/\" \"${CHECKPOINT_DEST}/\""
      },
      "copy-tar": {
        // Copy workspace using tar (fallback)
        "run": "(cd \"${RALPH_WORKSPACE}\" && tar --exclude='.git' --exclude='.ralph/sessions' --exclude='.ralph/checkpoints' -cf - .) | (cd \"${CHECKPOINT_DEST}\" && tar -xf -)"
      },
      "write-metadata": {
        // Write checkpoint metadata file
        "run": "{ echo \"created_at=$(date -u +%Y-%m-%dT%H:%M:%SZ)\"; echo \"label=${CHECKPOINT_LABEL:-unknown}\"; echo \"session_id=${RALPH_SESSION_ID:-session}\"; echo \"workspace=${RALPH_WORKSPACE:-.}\"; echo \"step=${RALPH_STEP:-}\"; echo \"plan_file=${RALPH_PLAN_FILE:-}\"; echo \"ticket=${RALPH_TICKET:-}\"; } > \"${CHECKPOINT_DEST}/.checkpoint.meta\""
      }
    },

    // Branch name utilities
    "branch": {
      "goal-slug": {
        // Convert goal to branch-safe slug
        "run": "printf '%s' \"${RALPH_GOAL:-goal}\" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g; s/--*/-/g; s/^-//; s/-$//'"
      },
      "segment": {
        // Convert free-form text to safe branch segment
        "run": "printf '%s' \"${BRANCH_SEGMENT:-none}\" | sed 's/[^A-Za-z0-9._/-]/-/g; s/--*/-/g; s#//*#/#g; s#^/##; s#/$##' | { read -r x; echo \"${x:-none}\"; }"
      },
      "render-name": {
        // Render branch name from template with tokens: {ticket} {goal_slug} {session_id} {date}
        "run": "echo \"${BRANCH_TEMPLATE:-ralph/{ticket}/{goal_slug}/{session_id}}\" | sed \"s/{ticket}/$(echo \"${RALPH_TICKET:-none}\" | sed 's/[^A-Za-z0-9._/-]/-/g')/g; s/{goal_slug}/$(echo \"${RALPH_GOAL:-goal}\" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g')/g; s/{session_id}/$(echo \"${RALPH_SESSION_ID:-session}\" | sed 's/[^A-Za-z0-9._/-]/-/g')/g; s/{date}/$(date +%Y%m%d)/g\""
      },
      "current": {
        // Print current branch name
        "run": "task:git.branch"
      },
      "checkout-new": {
        // Create and checkout new branch
        "run": "git -C \"${RALPH_WORKSPACE:-.}\" checkout -b \"${BRANCH_NAME}\" >/dev/null 2>&1"
      },
      "checkout-existing": {
        // Checkout existing branch
        "run": "git -C \"${RALPH_WORKSPACE:-.}\" checkout \"${BRANCH_NAME}\" >/dev/null 2>&1"
      },
      "exists": {
        // Check if branch exists
        "run": "git -C \"${RALPH_WORKSPACE:-.}\" show-ref --verify --quiet \"refs/heads/${BRANCH_NAME}\" 2>/dev/null"
      },
      "find-unique": {
        // Find unique branch name by appending -N if needed (max 99 attempts)
        "run": "name=\"${BRANCH_NAME}\"; n=2; while git -C \"${RALPH_WORKSPACE:-.}\" show-ref --verify --quiet \"refs/heads/${name}\" 2>/dev/null && [ $n -lt 100 ]; do name=\"${BRANCH_NAME}-${n}\"; n=$((n+1)); done; echo \"${name}\""
      }
    },

    // VCS agnostic operations
    "vcs": {
      "backend": {
        // Print detected VCS backend (git or filesystem-snapshot)
        "run": "task:git.is-repo && echo 'git' || echo 'filesystem-snapshot'"
      },
      "ref": {
        // Print current VCS reference (branch@commit or n/a)
        "run": "task:git.is-repo && echo \"$(task:git.branch)@$(task:git.head-short)\" || echo 'n/a'"
      },
      "commit-step": {
        // Create step commit if changes exist
        "when": "task:git.is-repo && task:git.has-changes",
        "run": "git -C \"${RALPH_WORKSPACE}\" add -A && git -C \"${RALPH_WORKSPACE}\" commit -m \"ralph(step ${RALPH_STEP:-?}): automated checkpoint${RALPH_TICKET:+ [${RALPH_TICKET}]}\" >/dev/null 2>&1 || true"
      }
    },

    // Git repository checks and helpers
    "git": {
      "is-repo": {
        // Exit 0 if workspace is inside a git repository
        "run": "git -C \"${RALPH_WORKSPACE:-.}\" rev-parse --is-inside-work-tree >/dev/null 2>&1"
      },
      "has-changes": {
        // Exit 0 if there are uncommitted changes
        "run": "test -n \"$(git -C \"${RALPH_WORKSPACE:-.}\" status --porcelain 2>/dev/null)\""
      },
      "branch": {
        // Print current branch name (or 'detached')
        "run": "git -C \"${RALPH_WORKSPACE:-.}\" symbolic-ref --quiet --short HEAD 2>/dev/null || echo 'detached'"
      },
      "head-short": {
        // Print short commit hash
        "run": "git -C \"${RALPH_WORKSPACE:-.}\" rev-parse --short HEAD 2>/dev/null || echo 'unknown'"
      },
      "status-short": {
        // Print short git status
        "run": "git -C \"${RALPH_WORKSPACE:-.}\" status --short 2>/dev/null || true"
      },
      "diff-stat": {
        // Print diff statistics
        "run": "git -C \"${RALPH_WORKSPACE:-.}\" diff --stat 2>/dev/null || true"
      }
    },

    // AI engines - detection, running, and metadata
    // Priority order for auto-detect is defined by "priority" (lower = preferred)
    "engines": [
      {
        "code": "codex",
        "label": "OpenAI Codex CLI",
        "priority": 1,
        "detect": "command -v codex >/dev/null 2>&1",
        "run": "codex exec --full-auto -C \"${RALPH_WORKSPACE:-.}\" ${RALPH_MODEL:+--model ${RALPH_MODEL}} -o \"${RALPH_RESPONSE_FILE}\" - < \"${RALPH_PROMPT_FILE}\"",
        "model_pattern": "^(gpt|codex|o1|o3)"
      },
      {
        "code": "claude",
        "label": "Claude Code CLI",
        "priority": 2,
        "detect": "command -v claude >/dev/null 2>&1",
        "run": "claude ${RALPH_MODEL:+--model ${RALPH_MODEL}} -p \"$(cat \"${RALPH_PROMPT_FILE}\")\" > \"${RALPH_RESPONSE_FILE}\"",
        "model_pattern": "^claude"
      },
      {
        "code": "ollama",
        "label": "Local models via Ollama",
        "priority": 3,
        "detect": "command -v ollama >/dev/null 2>&1 && ollama list >/dev/null 2>&1",
        "run": "ollama run \"${RALPH_MODEL:-deepseek-coder}\" < \"${RALPH_PROMPT_FILE}\" > \"${RALPH_RESPONSE_FILE}\""
      },
      {
        "code": "openai",
        "label": "OpenAI API",
        "priority": 4,
        "detect": "test -n \"${OPENAI_API_KEY:-}\"",
        "run": "curl -s https://api.openai.com/v1/chat/completions -H \"Authorization: Bearer ${OPENAI_API_KEY}\" -H \"Content-Type: application/json\" -d \"{\\\"model\\\": \\\"${RALPH_MODEL:-gpt-4}\\\", \\\"messages\\\": [{\\\"role\\\": \\\"user\\\", \\\"content\\\": $(jq -Rs . < \"${RALPH_PROMPT_FILE}\")}]}\" | jq -r '.choices[0].message.content' > \"${RALPH_RESPONSE_FILE}\"",
        "model_pattern": "^(gpt|o1|o3)"
      },
      {
        "code": "anthropic",
        "label": "Anthropic API",
        "priority": 5,
        "detect": "test -n \"${ANTHROPIC_API_KEY:-}\"",
        "run": "curl -s https://api.anthropic.com/v1/messages -H \"x-api-key: ${ANTHROPIC_API_KEY}\" -H \"anthropic-version: 2023-06-01\" -H \"Content-Type: application/json\" -d \"{\\\"model\\\": \\\"${RALPH_MODEL:-claude-sonnet-4-20250514}\\\", \\\"max_tokens\\\": 4096, \\\"messages\\\": [{\\\"role\\\": \\\"user\\\", \\\"content\\\": $(jq -Rs . < \"${RALPH_PROMPT_FILE}\")}]}\" | jq -r '.content[0].text' > \"${RALPH_RESPONSE_FILE}\"",
        "model_pattern": "^claude"
      },
      {
        "code": "mock",
        "label": "Simulated responses (testing)",
        "priority": 99,
        "detect": "true",
        "run": "task:engine.mock.generate"
      }
    ],

    // Mock engine helper (complex logic kept in task)
    "engine": {
      "mock": {
        "generate": {
          "run": "printf '##### Mock AI Response\\n\\n**Generated:** %s\\n**Engine:** mock\\n**Model:** %s\\n\\n---\\n\\nThis is a simulated response for testing.\\n' \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\" \"${RALPH_MODEL:-default}\" > \"${RALPH_RESPONSE_FILE}\""
        }
      }
    },

    // Test runner detection conditions
    "detect": {
      "makefile-test": {
        // True if Makefile exists with test target
        "run": "test -f \"${RALPH_WORKSPACE}/Makefile\" && grep -q '^test:' \"${RALPH_WORKSPACE}/Makefile\" 2>/dev/null"
      },
      "npm-test": {
        // True if package.json has test script
        "run": "test -f \"${RALPH_WORKSPACE}/package.json\" && grep -q '\"test\"' \"${RALPH_WORKSPACE}/package.json\" 2>/dev/null"
      },
      "pytest": {
        // True if pytest is available and project has Python config
        "run": "command -v pytest >/dev/null 2>&1 && (test -f \"${RALPH_WORKSPACE}/pytest.ini\" || test -f \"${RALPH_WORKSPACE}/setup.py\" || test -f \"${RALPH_WORKSPACE}/pyproject.toml\" || test -f \"${RALPH_WORKSPACE}/tox.ini\")"
      },
      "go-mod": {
        // True if go.mod exists
        "run": "test -f \"${RALPH_WORKSPACE}/go.mod\""
      },
      "cargo": {
        // True if Cargo.toml exists
        "run": "test -f \"${RALPH_WORKSPACE}/Cargo.toml\""
      },
      "tests-run-sh": {
        // True if tests/run.sh exists and is executable
        "run": "test -x \"${RALPH_WORKSPACE}/tests/run.sh\""
      }
    },

    // Test runner commands
    "test": {
      "make": {
        "when": "task:detect.makefile-test",
        "run": "make -C \"${RALPH_WORKSPACE}\" test"
      },
      "npm": {
        "when": "task:detect.npm-test",
        "run": "npm --prefix \"${RALPH_WORKSPACE}\" test"
      },
      "pytest": {
        "when": "task:detect.pytest",
        "run": "cd \"${RALPH_WORKSPACE}\" && pytest"
      },
      "go": {
        "when": "task:detect.go-mod",
        "run": "cd \"${RALPH_WORKSPACE}\" && go test ./..."
      },
      "cargo": {
        "when": "task:detect.cargo",
        "run": "cd \"${RALPH_WORKSPACE}\" && cargo test"
      },
      "repo-runner": {
        "when": "task:detect.tests-run-sh",
        "run": "cd \"${RALPH_WORKSPACE}\" && ./tests/run.sh"
      }
    },
    // Workflow selection tasks (optional; skipped if script is missing)
    "workflow-coding": {
      "when": "test -x \"${RALPH_PROJECT_DIR:-${RALPH_WORKSPACE}/.ralph}/lib/tasks/workflow-select.task.sh\"",
      "run": "\"${RALPH_PROJECT_DIR:-${RALPH_WORKSPACE}/.ralph}/lib/tasks/workflow-select.task.sh\" coding",
      "run_in_dry_run": false,
      "allow_failure": true
    },
    "workflow-project-management": {
      "when": "test -x \"${RALPH_PROJECT_DIR:-${RALPH_WORKSPACE}/.ralph}/lib/tasks/workflow-select.task.sh\"",
      "run": "\"${RALPH_PROJECT_DIR:-${RALPH_WORKSPACE}/.ralph}/lib/tasks/workflow-select.task.sh\" project-management",
      "run_in_dry_run": false,
      "allow_failure": true
    },
    "workflow-finance": {
      "when": "test -x \"${RALPH_PROJECT_DIR:-${RALPH_WORKSPACE}/.ralph}/lib/tasks/workflow-select.task.sh\"",
      "run": "\"${RALPH_PROJECT_DIR:-${RALPH_WORKSPACE}/.ralph}/lib/tasks/workflow-select.task.sh\" finance",
      "run_in_dry_run": false,
      "allow_failure": true
    },
    "workflow-non-code": {
      "when": "test -x \"${RALPH_PROJECT_DIR:-${RALPH_WORKSPACE}/.ralph}/lib/tasks/workflow-select.task.sh\"",
      "run": "\"${RALPH_PROJECT_DIR:-${RALPH_WORKSPACE}/.ralph}/lib/tasks/workflow-select.task.sh\" non-code",
      "run_in_dry_run": false,
      "allow_failure": true
    },
    // Optional version-control hook behavior
    "version-control": {
      "when": "test -x \"${RALPH_PROJECT_DIR:-${RALPH_WORKSPACE}/.ralph}/lib/tasks/version-control.task.sh\"",
      "run": "RALPH_HOOK_DEPTH=\"$(( ${RALPH_HOOK_DEPTH:-0} + 1 ))\" \"${RALPH_PROJECT_DIR:-${RALPH_WORKSPACE}/.ralph}/lib/tasks/version-control.task.sh\"",
      "run_in_dry_run": false,
      "allow_failure": true
    },
    // Version/commit reporting helpers
    "version": {
      "git-rev-short": {
        // Prints short commit hash if git is available
        "run": "git -C \"${repo_root:-.}\" rev-parse --short HEAD 2>/dev/null || true"
      },
      "has-git": {
        // Exit 0 if git repo is present and readable
        "run": "git -C \"${repo_root:-.}\" rev-parse --short HEAD >/dev/null 2>&1"
      },
      "print-with-commit": {
        // Print version with current commit hash
        "run": "echo \"ralph ${RALPH_VERSION} (commit: $(git -C \"${repo_root:-.}\" rev-parse --short HEAD))\""
      },
      "print-simple": {
        // Print version without git info
        "run": "echo \"ralph ${RALPH_VERSION}\""
      },
      "print": {
        // Prefer commit-aware output when possible
        "run": "task:version.has-git && task:version.print-with-commit || task:version.print-simple"
      }
    }
  }
}
